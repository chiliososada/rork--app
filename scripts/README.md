# セキュリティマイグレーションスクリプト

このディレクトリには、TokyoParkアプリのセキュリティシステムをアップグレードするためのマイグレーションスクリプトが含まれています。

## 暗号化マイグレーション

### 概要

`encryption-migration.ts` スクリプトは、古いXOR暗号化システムから新しいAES-256-GCM暗号化システムにチャットメッセージをアップグレードします。

### 使用方法

#### 1. ドライラン（推奨）

実際の変更を行う前に、どのメッセージがアップグレード対象かを確認：

```bash
npm run migrate-encryption -- --dry-run
```

#### 2. 本格実行

```bash
npm run migrate-encryption
```

#### 3. オプション付き実行

```bash
# バッチサイズを50に設定し、最大5バッチまで処理
npm run migrate-encryption -- --batch-size=50 --max-batches=5

# ドライランでバッチサイズ100、最大10バッチ
npm run migrate-encryption -- --dry-run --batch-size=100 --max-batches=10
```

### オプション

- `--dry-run`: 実際の変更を行わず、結果のみを表示
- `--batch-size=N`: 一度に処理するメッセージ数（デフォルト: 100）
- `--max-batches=N`: 処理する最大バッチ数（デフォルト: 無制限）
- `--help`, `-h`: ヘルプを表示

### マイグレーション対象

以下の条件に一致するメッセージが対象となります：
- `ENC_` または `ENC2_` で始まる暗号化メッセージ
- 古いXOR暗号化方式を使用しているメッセージ

### セキュリティ上の注意

1. **バックアップ**: マイグレーション前に必ずデータベースのバックアップを取ってください
2. **テスト環境**: 本番環境での実行前に、テスト環境で動作を確認してください
3. **バッチ処理**: 大量のデータがある場合は、小さなバッチサイズから始めてください

### トラブルシューティング

#### エラー: 環境変数が設定されていない

```
❌ Supabase環境変数が設定されていません
```

**解決策**: `.env` ファイルに以下を設定：
```
REACT_APP_SUPABASE_URL=your_supabase_url
REACT_APP_SUPABASE_ANON_KEY=your_supabase_anon_key
```

#### エラー: 復号化失敗

一部のメッセージで復号化に失敗する場合があります。これは以下の原因が考えられます：
- 既に新しい暗号化方式を使用している
- 破損したデータ
- 異なる暗号化キーで暗号化された

これらのメッセージは自動的にスキップされ、エラーカウントに含まれます。

### パフォーマンス

- **バッチ処理**: メッセージは指定されたバッチサイズで処理されます
- **レート制限**: バッチ間に1秒の待機時間があります
- **メモリ効率**: 大量のデータでもメモリ使用量を抑制します

### レポート例

```
📋 マイグレーション完了レポート
==================================================
合計メッセージ数: 1500
処理済みメッセージ数: 1500
アップグレード済み: 1200
スキップ済み: 280
エラー数: 20
処理バッチ数: 15

✅ マイグレーション完了！
```

## 今後の拡張

このディレクトリには、将来的に以下のようなマイグレーションスクリプトが追加される予定です：

- 位置情報プライバシー設定のマイグレーション
- ユーザー権限システムのアップグレード
- コンテンツモデレーション設定の移行

## サポート

マイグレーションで問題が発生した場合は、以下の情報を含めて報告してください：

1. 実行したコマンド
2. エラーメッセージの全文
3. 環境情報（Node.js バージョン、OS など）
4. ドライランの結果（可能であれば）